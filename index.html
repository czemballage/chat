<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ChatApp</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdn.jsdelivr.net/npm/remixicon@4.5.0/fonts/remixicon.css" rel="stylesheet">
    <style>
        :root {
            --primary: #0069FF;
            --message-outgoing: #0069FF;
            --message-incoming: #262626;
            --bg-chat: #121212;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background-color: var(--bg-chat);
            color: #fff;
            max-width: 100%;
            margin: 0;
            padding: 0;
            height: 100vh;
            overflow: hidden;
        }

        .chat-container {
            height: calc(100vh - 140px);
            overflow-y: auto;
            padding: 10px 15px 20px;
            scroll-behavior: smooth;
            background-color: var(--bg-chat);
            margin-top: 60px;
            width: 100%;
            display: flex;
            flex-direction: column;
        }

        .message {
            max-width: 85%;
            margin: 8px 0;
            padding: 10px 14px;
            border-radius: 18px;
            font-size: 14px;
            line-height: 1.5;
            word-wrap: break-word;
            position: relative;
            animation: fadeIn 0.2s ease-out;
            box-shadow: 0 1px 2px rgba(0,0,0,0.1);
            transition: transform 0.2s ease;
        }

        .message:hover {
            transform: translateY(-1px);
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(5px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .message.self {
            background-color: var(--message-outgoing);
            color: white;
            align-self: flex-end;
            border-bottom-right-radius: 6px;
            margin-left: auto;
        }

        .message:not(.self) {
            background-color: var(--message-incoming);
            color: white;
            align-self: flex-start;
            border-bottom-left-radius: 6px;
            margin-right: auto;
        }

        .input-container {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background-color: #1a1a1a;
            padding: 10px 15px;
            display: flex;
            align-items: center;
            gap: 10px;
            border-top: 1px solid #2a2a2a;
            box-shadow: 0 -2px 10px rgba(0,0,0,0.1);
            height: 60px;
        }

        .message-input {
            flex: 1;
            background-color: #313131;
            border: none;
            border-radius: 24px;
            padding: 12px 18px;
            color: white;
            font-size: 15px;
            box-shadow: inset 0 1px 3px rgba(0,0,0,0.2);
            width: 100%;
        }

        .text-direction-indicator {
            position: absolute;
            right: 15px;
            top: 12px;
            font-size: 12px;
            color: rgba(255,255,255,0.6);
            background-color: rgba(0,0,0,0.3);
            padding: 2px 6px;
            border-radius: 4px;
            pointer-events: none;
            opacity: 0;
            transition: opacity 0.3s ease;
            display: none;
        }
        
        .text-direction-indicator.visible {
            opacity: 1;
        }
        
        .input-content-area {
            flex: 1;
            position: relative;
        }
        
        .message p {
            margin: 0;
            white-space: pre-wrap;
            overflow-wrap: break-word;
        }
        
        .message-toolbar {
            position: absolute;
            top: -40px;
            background-color: #333;
            border-radius: 8px;
            padding: 5px;
            display: none;
            box-shadow: 0 2px 10px rgba(0,0,0,0.2);
            z-index: 10;
        }
        
        .message-toolbar.active {
            display: flex;
            animation: fadeIn 0.2s ease-out;
        }
        
        .toolbar-button {
            background: none;
            border: none;
            color: white;
            padding: 5px;
            cursor: pointer;
            font-size: 16px;
            border-radius: 4px;
        }
        
        .toolbar-button:hover {
            background-color: rgba(255,255,255,0.1);
        }
        
        .action-button.recording {
            background-color: #ff4d4f;
            color: white;
            animation: pulse 1.5s infinite;
        }
        
        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.1); }
            100% { transform: scale(1); }
        }

        .action-button {
            background: none;
            border: none;
            color: #a0a0a0;
            padding: 8px;
            cursor: pointer;
            font-size: 24px;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
        }

        .action-button:hover, .action-button:active {
            background-color: rgba(255,255,255,0.1);
            color: var(--primary);
        }

        .action-button.send {
            background-color: var(--primary);
            color: white;
        }

        .chat-header {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            background-color: #1a1a1a;
            padding: 12px 15px;
            display: flex;
            align-items: center;
            gap: 15px;
            border-bottom: 1px solid #2a2a2a;
            z-index: 10;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            height: 60px;
        }

        .back-button {
            color: var(--primary);
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            transition: background-color 0.2s;
        }

        .back-button:hover {
            background-color: rgba(255,255,255,0.1);
        }

        .timestamp {
            font-size: 11px;
            color: rgba(255,255,255,0.5);
            margin-top: 4px;
            display: block;
            text-align: left;
        }

        .message:not(.self) .timestamp {
            text-align: right;
        }

        .message-username {
            font-size: 12px;
            font-weight: 500;
            color: #a0a0a0;
            margin-bottom: 3px;
            display: block;
        }
        
        .message.self .message-username {
            display: none;
        }

        .image-message {
            max-width: 100%;
            width: auto;
            max-height: 300px;
            border-radius: 12px;
            margin-bottom: 4px;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 2px 8px rgba(0,0,0,0.2);
        }
        
        .image-message:hover {
            transform: scale(1.02);
        }
        
        .image-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(0,0,0,0.9);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s ease;
        }
        
        .image-overlay.active {
            opacity: 1;
            pointer-events: all;
        }
        
        .image-overlay img {
            max-width: 90%;
            max-height: 90%;
            object-fit: contain;
        }
        
        .image-overlay .close-button {
            position: absolute;
            top: 20px;
            right: 20px;
            color: white;
            font-size: 24px;
            cursor: pointer;
            background: rgba(0,0,0,0.5);
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .page {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: flex;
            justify-content: center;
            align-items: center;
            transition: opacity 0.3s ease-in-out, transform 0.3s ease-in-out;
        }
        
        .page.hidden {
            opacity: 0;
            transform: translateY(20px);
            pointer-events: none;
        }

        .message-reactions {
            display: flex;
            gap: 5px;
            margin-top: 4px;
        }

        .reaction-count {
            background-color: rgba(255,255,255,0.15);
            border-radius: 16px;
            padding: 3px 10px;
            font-size: 12px;
            display: flex;
            align-items: center;
            gap: 4px;
            box-shadow: 0 1px 2px rgba(0,0,0,0.1);
            transition: all 0.2s ease;
        }

        .reaction-count:hover {
            background-color: rgba(255,255,255,0.2);
        }

        .message-date {
            text-align: center;
            margin: 8px 0;
            font-size: 12px;
            color: rgba(255,255,255,0.5);
            align-self: center;
            display: none;
        }

        .username-container {
            background-color: rgba(0,0,0,0.7);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.3);
            border: 1px solid rgba(255,255,255,0.1);
            width: 100%;
            max-width: 400px;
            position: relative;
            z-index: 2;
        }

        .auth-tabs {
            display: flex;
            margin-bottom: 20px;
            border-bottom: 1px solid rgba(255,255,255,0.1);
        }

        .auth-tab {
            flex: 1;
            text-align: center;
            padding: 10px;
            cursor: pointer;
            color: #a0a0a0;
            transition: all 0.3s ease;
        }

        .auth-tab.active {
            color: var(--primary);
            border-bottom: 2px solid var(--primary);
        }

        .auth-form {
            display: none;
        }

        .auth-form.active {
            display: block;
        }

        .form-group {
            margin-bottom: 15px;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            color: #a0a0a0;
            font-size: 14px;
        }

        .auth-error {
            color: #ff4d4f;
            font-size: 14px;
            margin-top: 10px;
            text-align: center;
        }

        /* Adaptive layout for different screen sizes */
        @media (min-width: 768px) {
            .chat-container {
                max-width: 800px;
                margin: 60px auto 0;
                height: calc(100vh - 140px);
                padding-bottom: 20px;
            }
            
            .input-container, .chat-header {
                max-width: 800px;
                margin: 0 auto;
                left: 0;
                right: 0;
            }
        }

        @media (max-width: 767px) {
            .message {
                max-width: 75%;
            }
        }
        
        .animated-background {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: -1;
            background: rgba(0, 0, 0, 0.7);
            overflow: hidden;
        }
        
        .animated-background::before {
            content: "";
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: url('https://i.gifer.com/LCPT.gif') center center no-repeat;
            background-size: cover;
            opacity: 0.4;
            filter: blur(2px);
            z-index: -1;
        }
        
        .groups-container {
            padding: 70px 10px 20px;
            height: 100vh;
            overflow-y: auto;
        }
        
        .group-item {
            display: flex;
            padding: 15px;
            border-radius: 12px;
            margin-bottom: 10px;
            background-color: #1a1a1a;
            transition: all 0.2s ease;
            cursor: pointer;
            align-items: center;
        }
        
        .group-item:hover, .group-item:active {
            background-color: #262626;
            transform: translateY(-2px);
        }
        
        .group-avatar {
            width: 50px;
            height: 50px;
            border-radius: 25px;
            background-color: var(--primary);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            margin-left: 15px;
        }
        
        .group-info {
            flex: 1;
        }
        
        .group-name {
            font-weight: 600;
            font-size: 16px;
            color: white;
            margin: 0 0 5px;
        }
        
        .group-last-message {
            color: #a0a0a0;
            font-size: 14px;
            margin: 0;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            max-width: 180px;
        }
        
        .group-meta {
            display: flex;
            flex-direction: column;
            align-items: flex-end;
            gap: 5px;
        }
        
        .group-time {
            font-size: 12px;
            color: #a0a0a0;
        }
        
        .group-unread {
            background-color: var(--primary);
            color: white;
            font-size: 12px;
            width: 24px;
            height: 24px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .fab-container {
            position: fixed;
            bottom: 20px;
            left: 20px;
            z-index: 100;
        }
        
        .new-chat-button {
            width: 60px;
            height: 60px;
            border-radius: 30px;
            background-color: var(--primary);
            color: white;
            font-size: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 4px 15px rgba(0, 105, 255, 0.4);
            cursor: pointer;
            border: none;
            transition: all 0.2s ease;
        }
        
        .new-chat-button:hover {
            transform: scale(1.05);
            box-shadow: 0 6px 20px rgba(0, 105, 255, 0.5);
        }
        
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(0,0,0,0.7);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s ease;
        }
        
        .modal-overlay.active {
            opacity: 1;
            pointer-events: all;
        }
        
        .modal-container {
            background-color: #1a1a1a;
            border-radius: 12px;
            width: 90%;
            max-width: 500px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.3);
            border: 1px solid rgba(255,255,255,0.1);
        }
        
        .modal-header {
            padding: 15px 20px;
            border-bottom: 1px solid rgba(255,255,255,0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .modal-header h3 {
            margin: 0;
            font-size: 18px;
            font-weight: 600;
        }
        
        .modal-body {
            padding: 20px;
        }
        
        .modal-footer {
            padding: 15px 20px;
            border-top: 1px solid rgba(255,255,255,0.1);
        }
    </style>
</head>
<body>
    <!-- Auth Page -->
    <div id="auth-page" class="page fixed inset-0 flex items-center justify-center bg-black">
        <div class="animated-background"></div>
        <div class="username-container">
            <h1 class="text-2xl font-bold text-center mb-8 text-white">Welcome to <span class="text-primary">ChatApp</span></h1>
            
            <div class="auth-tabs">
                <div class="auth-tab active" id="login-tab">تسجيل الدخول</div>
                <div class="auth-tab" id="register-tab">إنشاء حساب</div>
            </div>
            
            <!-- Login Form -->
            <div class="auth-form active" id="login-form">
                <div class="form-group">
                    <label>اسم المستخدم</label>
                    <input type="text" id="login-username" placeholder="أدخل اسم المستخدم" 
                        class="w-full p-4 rounded-lg bg-[#313131] text-white border-none focus:outline-none focus:ring-2 focus:ring-primary">
                </div>
                <div class="form-group">
                    <label>كلمة المرور</label>
                    <input type="password" id="login-password" placeholder="أدخل كلمة المرور" 
                        class="w-full p-4 rounded-lg bg-[#313131] text-white border-none focus:outline-none focus:ring-2 focus:ring-primary">
                </div>
                <div class="auth-error" id="login-error"></div>
                <button id="login-button" 
                    class="w-full p-4 rounded-lg bg-primary text-white font-medium transition-all hover:bg-opacity-90 active:scale-98 mt-4">
                    تسجيل الدخول
                </button>
            </div>
            
            <!-- Register Form -->
            <div class="auth-form" id="register-form">
                <div class="form-group">
                    <label>اسم المستخدم</label>
                    <input type="text" id="register-username" placeholder="أدخل اسم المستخدم الجديد" 
                        class="w-full p-4 rounded-lg bg-[#313131] text-white border-none focus:outline-none focus:ring-2 focus:ring-primary">
                </div>
                <div class="form-group">
                    <label>كلمة المرور</label>
                    <input type="password" id="register-password" placeholder="أدخل كلمة المرور" 
                        class="w-full p-4 rounded-lg bg-[#313131] text-white border-none focus:outline-none focus:ring-2 focus:ring-primary">
                </div>
                <div class="form-group">
                    <label>تأكيد كلمة المرور</label>
                    <input type="password" id="register-confirm-password" placeholder="أعد إدخال كلمة المرور" 
                        class="w-full p-4 rounded-lg bg-[#313131] text-white border-none focus:outline-none focus:ring-2 focus:ring-primary">
                </div>
                <div class="auth-error" id="register-error"></div>
                <button id="register-button" 
                    class="w-full p-4 rounded-lg bg-primary text-white font-medium transition-all hover:bg-opacity-90 active:scale-98 mt-4">
                    إنشاء حساب
                </button>
            </div>
        </div>
    </div>

    <!-- Groups Page -->
    <div id="groups-page" class="page hidden">
        <div class="chat-header">
            <div class="flex-1">
                <h1 class="text-lg font-medium">المحادثات</h1>
                <span class="text-sm text-gray-400">اختر مجموعة للدردشة</span>
            </div>
            <button id="logout-button" class="action-button">
                <i class="ri-logout-box-line"></i>
            </button>
        </div>

        <div class="groups-container">
            <div class="group-item" id="main-group">
                <div class="group-avatar">
                    <i class="ri-group-line"></i>
                </div>
                <div class="group-info">
                    <h3 class="group-name">المجموعة العامة</h3>
                    <p class="group-last-message">انضم للدردشة مع الجميع</p>
                </div>
                <div class="group-meta">
                    <span class="group-time">الآن</span>
                    <span class="group-unread">14</span>
                </div>
            </div>
            <div class="group-item" id="group-friends">
                <div class="group-avatar">
                    <i class="ri-team-line"></i>
                </div>
                <div class="group-info">
                    <h3 class="group-name">مجموعة الأصدقاء</h3>
                    <p class="group-last-message">للنقاشات الودية والمرح</p>
                </div>
                <div class="group-meta">
                    <span class="group-time">الآن</span>
                    <span class="group-unread">5</span>
                </div>
            </div>
            <div class="group-item" id="group-tech">
                <div class="group-avatar">
                    <i class="ri-code-line"></i>
                </div>
                <div class="group-info">
                    <h3 class="group-name">مجموعة التقنية</h3>
                    <p class="group-last-message">لمناقشة أحدث التقنيات</p>
                </div>
                <div class="group-meta">
                    <span class="group-time">الآن</span>
                    <span class="group-unread">3</span>
                </div>
            </div>
            <div class="group-item" id="group-gaming">
                <div class="group-avatar">
                    <i class="ri-gamepad-line"></i>
                </div>
                <div class="group-info">
                    <h3 class="group-name">مجموعة الألعاب</h3>
                    <p class="group-last-message">لمحبي الألعاب الإلكترونية</p>
                </div>
                <div class="group-meta">
                    <span class="group-time">الآن</span>
                    <span class="group-unread">8</span>
                </div>
            </div>
            <div class="group-item" id="group-sports">
                <div class="group-avatar">
                    <i class="ri-basketball-line"></i>
                </div>
                <div class="group-info">
                    <h3 class="group-name">مجموعة الرياضة</h3>
                    <p class="group-last-message">لمتابعة أخبار الرياضة</p>
                </div>
                <div class="group-meta">
                    <span class="group-time">الآن</span>
                    <span class="group-unread">6</span>
                </div>
            </div>
            <div class="group-item" id="group-movies">
                <div class="group-avatar">
                    <i class="ri-movie-line"></i>
                </div>
                <div class="group-info">
                    <h3 class="group-name">مجموعة الأفلام</h3>
                    <p class="group-last-message">لمناقشة الأفلام والمسلسلات</p>
                </div>
                <div class="group-meta">
                    <span class="group-time">الآن</span>
                    <span class="group-unread">2</span>
                </div>
            </div>
            <div class="group-item" id="group-music">
                <div class="group-avatar">
                    <i class="ri-music-line"></i>
                </div>
                <div class="group-info">
                    <h3 class="group-name">مجموعة الموسيقى</h3>
                    <p class="group-last-message">لمحبي الموسيقى والغناء</p>
                </div>
                <div class="group-meta">
                    <span class="group-time">الآن</span>
                    <span class="group-unread">4</span>
                </div>
            </div>
            <div class="group-item" id="group-cooking">
                <div class="group-avatar">
                    <i class="ri-restaurant-line"></i>
                </div>
                <div class="group-info">
                    <h3 class="group-name">مجموعة الطبخ</h3>
                    <p class="group-last-message">لتبادل وصفات الطعام</p>
                </div>
                <div class="group-meta">
                    <span class="group-time">الآن</span>
                    <span class="group-unread">9</span>
                </div>
            </div>
            <div class="group-item" id="group-travel">
                <div class="group-avatar">
                    <i class="ri-plane-line"></i>
                </div>
                <div class="group-info">
                    <h3 class="group-name">مجموعة السفر</h3>
                    <p class="group-last-message">لمشاركة تجارب السفر</p>
                </div>
                <div class="group-meta">
                    <span class="group-time">الآن</span>
                    <span class="group-unread">1</span>
                </div>
            </div>
            <div class="group-item" id="group-books">
                <div class="group-avatar">
                    <i class="ri-book-line"></i>
                </div>
                <div class="group-info">
                    <h3 class="group-name">مجموعة الكتب</h3>
                    <p class="group-last-message">لمناقشة الكتب والقراءة</p>
                </div>
                <div class="group-meta">
                    <span class="group-time">الآن</span>
                    <span class="group-unread">7</span>
                </div>
            </div>
        </div>
    </div>

    <!-- Chat Page -->
    <div id="chat-page" class="page hidden">
        <div class="chat-header">
            <button id="back-to-menu" class="back-button">
                <i class="ri-arrow-left-line"></i>
            </button>
            <div class="flex-1">
                <h1 class="text-lg font-medium">Group Chat</h1>
                <span class="text-sm text-gray-400">Online</span>
            </div>
            <button class="action-button">
                <i class="ri-more-2-fill"></i>
            </button>
        </div>

        <div id="chat-messages" class="chat-container">
        </div>

        <div class="input-container">
            <button class="action-button" id="image-button">
                <i class="ri-image-line"></i>
            </button>
            <div class="input-content-area">
                <input type="text" id="message-text" class="message-input" placeholder="Message">
                <span class="text-direction-indicator" id="text-direction" style="display: none;"></span>
            </div>
            <button id="send-message" class="action-button send">
                <i class="ri-send-plane-fill"></i>
            </button>
            <input type="file" id="image-upload" accept="image/*" style="display: none;">
        </div>
    </div>

    <div id="image-overlay" class="image-overlay">
        <div class="close-button" id="close-image-button">
            <i class="ri-close-line"></i>
        </div>
        <img id="enlarged-image" src="" alt="Enlarged image">
    </div>

    <!-- New Group Modal -->
    <div id="new-group-modal" class="modal-overlay">
        <div class="modal-container">
            <div class="modal-header">
                <h3>إنشاء مجموعة جديدة</h3>
                <div class="close-button" id="close-group-modal">
                    <i class="ri-close-line"></i>
                </div>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label>اسم المجموعة</label>
                    <input type="text" id="group-name" placeholder="أدخل اسم المجموعة" 
                        class="w-full p-4 rounded-lg bg-[#313131] text-white border-none focus:outline-none focus:ring-2 focus:ring-primary">
                </div>
                <div class="form-group">
                    <label>وصف المجموعة</label>
                    <input type="text" id="group-description" placeholder="أدخل وصفاً للمجموعة" 
                        class="w-full p-4 rounded-lg bg-[#313131] text-white border-none focus:outline-none focus:ring-2 focus:ring-primary">
                </div>
            </div>
            <div class="modal-footer">
                <button id="create-group-button" 
                    class="w-full p-4 rounded-lg bg-primary text-white font-medium transition-all hover:bg-opacity-90 active:scale-98 mt-4">
                    إنشاء المجموعة
                </button>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-app.js";
        import { getDatabase, ref, push, onValue, update, onDisconnect, set, get, remove } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-database.js";
        import { getStorage, ref as storageRef, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-storage.js";
        import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, updateProfile, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-auth.js";

        const firebaseConfig = {
            apiKey: "AIzaSyBZadnRIb9OAGAQPsTFvnXeIYcX1Y1T9KQ",
            authDomain: "bakiii.firebaseapp.com",
            databaseURL: "https://bakiii-default-rtdb.firebaseio.com",
            projectId: "bakiii",
            storageBucket: "bakiii.appspot.com",
            messagingSenderId: "188557547193",
            appId: "1:188557547193:web:f9d1eed660c400e825ad68",
            measurementId: "G-J2CKKB8GN6"
        };

        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);
        const storage = getStorage(app);
        const auth = getAuth(app);

        let username = '';
        let userRef;
        let currentChatId = null;
        let activeUsersRefs = {};

        function initializeUser() {
            userRef = ref(db, 'users/' + username);
            set(userRef, {
                lastActive: Date.now(),
                isOnline: true
            });

            onDisconnect(userRef).update({
                isOnline: false
            });
            
            updateActiveUsersCount();
            showPage('groups-page');
        }
        
        function updateUserActivity() {
            if (userRef) {
                update(userRef, {
                    lastActive: Date.now(),
                    isOnline: true
                });
            }
        }

        async function registerUser(username, password, confirmPassword) {
            const registerError = document.getElementById('register-error');
            registerError.textContent = '';
            
            if (!username || !password) {
                registerError.textContent = 'الرجاء إدخال اسم المستخدم وكلمة المرور';
                return false;
            }
            
            if (password !== confirmPassword) {
                registerError.textContent = 'كلمة المرور غير متطابقة';
                return false;
            }
            
            const usersRef = ref(db, 'users');
            const snapshot = await get(usersRef);
            if (snapshot.exists()) {
                const users = snapshot.val();
                if (users[username]) {
                    registerError.textContent = 'اسم المستخدم موجود بالفعل';
                    return false;
                }
            }
            
            try {
                const email = `${username}@chatapp.example`;
                
                await createUserWithEmailAndPassword(auth, email, password);
                
                await set(ref(db, `users/${username}`), {
                    username: username,
                    lastActive: Date.now(),
                    isOnline: true,
                    createdAt: Date.now()
                });
                
                return true;
            } catch (error) {
                console.error('Error registering user:', error);
                registerError.textContent = 'حدث خطأ أثناء إنشاء الحساب';
                return false;
            }
        }

        async function loginUser(username, password) {
            const loginError = document.getElementById('login-error');
            loginError.textContent = '';
            
            if (!username || !password) {
                loginError.textContent = 'الرجاء إدخال اسم المستخدم وكلمة المرور';
                return false;
            }
            
            try {
                const email = `${username}@chatapp.example`;
                
                await signInWithEmailAndPassword(auth, email, password);
                
                const userSnapshot = await get(ref(db, `users/${username}`));
                if (!userSnapshot.exists()) {
                    loginError.textContent = 'اسم المستخدم غير موجود';
                    return false;
                }
                
                return true;
            } catch (error) {
                console.error('Error logging in:', error);
                loginError.textContent = 'اسم المستخدم أو كلمة المرور غير صحيحة';
                return false;
            }
        }

        async function sendMessage(messageText, imageUrl = null) {
            if (!username || (!messageText && !imageUrl)) {
                alert('Please enter a message or select an image.');
                return;
            }
            
            const chatRef = ref(db, currentChatId ? `groupChats/${currentChatId}` : 'chat/');
            const timestamp = Date.now();
            
            await push(chatRef, {
                username: username,
                text: messageText,
                timestamp: timestamp,
                imageUrl: imageUrl
            });
            
            const messagesSnapshot = await get(chatRef);
            if (messagesSnapshot.exists()) {
                const messages = [];
                messagesSnapshot.forEach((childSnapshot) => {
                    messages.push({
                        id: childSnapshot.key,
                        ...childSnapshot.val()
                    });
                });
                
                messages.sort((a, b) => a.timestamp - b.timestamp);
                
                if (messages.length > 50) {
                    const messagesToDelete = messages.slice(0, messages.length - 50);
                    for (const message of messagesToDelete) {
                        const messageRef = ref(db, `${currentChatId ? `groupChats/${currentChatId}` : 'chat/'}/${message.id}`);
                        await remove(messageRef);
                    }
                }
            }
            
            updateUserActivity();
        }

        function displayMessages(isGroup = false) {
            const chatRef = ref(db, isGroup ? `groupChats/${currentChatId}` : 'chat/');
            const chatContainer = document.getElementById('chat-messages');

            onValue(chatRef, (snapshot) => {
                chatContainer.innerHTML = '';
                
                if (snapshot.exists()) {
                    const messages = [];
                    snapshot.forEach((childSnapshot) => {
                        messages.push({
                            id: childSnapshot.key,
                            ...childSnapshot.val()
                        });
                    });
                    
                    messages.sort((a, b) => a.timestamp - b.timestamp);
                    
                    messages.forEach(message => {
                        const messageElement = document.createElement('div');
                        messageElement.classList.add('message');
                        messageElement.dataset.id = message.id;
                        
                        if (message.username === username) {
                            messageElement.classList.add('self');
                        } else {
                            const usernameElement = document.createElement('span');
                            usernameElement.classList.add('message-username');
                            usernameElement.textContent = message.username;
                            messageElement.appendChild(usernameElement);
                        }
                        
                        if (message.imageUrl) {
                            const img = document.createElement('img');
                            img.src = message.imageUrl;
                            img.classList.add('image-message');
                            messageElement.appendChild(img);
                        }
                        
                        if (message.text) {
                            const textElement = document.createElement('p');
                            textElement.textContent = message.text;
                            
                            const direction = detectTextDirection(message.text);
                            textElement.style.direction = direction;
                            
                            messageElement.appendChild(textElement);
                        }
                        
                        const timestampElement = document.createElement('span');
                        timestampElement.classList.add('timestamp');
                        timestampElement.textContent = new Date(message.timestamp).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
                        messageElement.appendChild(timestampElement);
                        
                        chatContainer.appendChild(messageElement);
                    });
                }
                chatContainer.scrollTop = chatContainer.scrollHeight;
            });
        }

        async function uploadImage(file, isPrivate = false) {
            if (!file) return;
            
            const imageRef = storageRef(storage, `chatImages/${Date.now()}_${file.name}`);
            try {
                await uploadBytes(imageRef, file);
                const downloadURL = await getDownloadURL(imageRef);
                await sendMessage('', downloadURL);
            } catch (error) {
                console.error("Error uploading image: ", error);
                alert("Failed to upload image. Please try again.");
            }
        }

        function showPage(pageId) {
            document.querySelectorAll('.page').forEach(page => {
                page.classList.add('hidden');
                page.style.opacity = '0';
                page.style.transform = 'translateY(20px)';
            });
            const newPage = document.getElementById(pageId);
            newPage.classList.remove('hidden');
            setTimeout(() => {
                newPage.style.opacity = '1';
                newPage.style.transform = 'translateY(0)';
            }, 50);
        }

        function triggerFileInput(inputId) {
            document.getElementById(inputId).click();
        }

        const emojiData = {
            smileys: ["😀", "😃", "😄", "😁", "😆", "😅", "😂", "🤣", "😊", "😇", "🙂", "🙃", "😉", "😌", "😍", "🥰", "😘", "😗", "😙", "😚", "😋", "😛", "😝", "😜", "🤪", "🤨", "🧐", "🤓", "😎", "🤩", "🥳"],
            people: ["👋", "🤚", "✋", "🖖", "👌", "✌️", "🤞", "🤟", "🤘", "🤙", "👈", "👉", "👆", "👇", "👍", "👎", "✊", "👊", "🤛", "🤜", "👏", "🙌", "👐", "🤲", "🤝", "🙏"],
            animals: ["🐶", "🐱", "🐭", "🐹", "🐰", "🦊", "🐻", "🐼", "🐨", "🐯", "🦁", "🐮", "🐷", "🐸", "🐵", "🐔", "🐧", "🐦", "🐤", "🦆", "🦅", "🦉", "🦇", "🐺", "🐗", "🐴"],
            food: ["🍏", "🍎", "🍐", "🍊", "🍋", "🍌", "🍉", "🍇", "🍓", "🍈", "🍒", "🍑", "🥭", "🍍", "🥥", "🥝", "🍅", "🥑", "🍆", "🥦", "🥬", "🥒", "🌶️", "🌽", "🥕"],
            travel: ["🚗", "🚕", "🚙", "🚌", "🚎", "🏎️", "🚓", "🚑", "🚒", "🚐", "🚚", "🚛", "🚜", "🛴", "🚲", "🛵", "🏍️", "🚨", "🚔", "🚍", "🚘", "🚖", "🚡", "🚠", "✈️", "🛫"],
            activities: ["⚽", "🏀", "🏈", "⚾", "🥎", "🎾", "🏐", "🏉", "🥏", "🎱", "🪀", "🏓", "🏸", "🏒", "🏑", "🥍", "🏏", "🥅", "⛳", "🪁", "🎣", "🤿", "🎽", "🎿", "🛷"],
            objects: ["⌚", "📱", "💻", "⌨️", "🖥️", "🖨️", "🖱️", "🖲️", "🕹️", "🗜️", "💽", "💾", "💿", "📀", "📼", "📷", "📸", "📹", "🎥", "📽️", "📞", "☎️", "📟", "📠", "📺"],
            symbols: ["❤️", "🧡", "💛", "💚", "💙", "💜", "🖤", "🤍", "🤎", "💔", "❣️", "💕", "💞", "💓", "💗", "💖", "💘", "💝", "💟", "☮️", "✝️", "☪️", "🕉️", "☸️", "✡️"]
        };

        let selectedMessageForAction = null;
        let currentVoiceRecording = null;
        let isRecording = false;

        function detectTextDirection(text) {
            const arabicPattern = /[\u0600-\u06FF]/;
            return arabicPattern.test(text) ? 'rtl' : 'ltr';
        }

        function updateTextDirectionIndicator(text) {
            const directionIndicator = document.getElementById('text-direction');
            const direction = detectTextDirection(text);
            directionIndicator.textContent = direction === 'rtl' ? 'عربي' : 'English';
            
            directionIndicator.classList.add('visible');
            
            clearTimeout(window.directionIndicatorTimeout);
            window.directionIndicatorTimeout = setTimeout(() => {
                directionIndicator.classList.remove('visible');
            }, 1500);
            
            const messageInput = document.getElementById('message-text');
            messageInput.style.textAlign = direction === 'rtl' ? 'right' : 'left';
            messageInput.style.direction = direction;
        }

        function initializeMessageActions() {
            const toolbar = document.getElementById('message-toolbar');
            const copyButton = document.getElementById('copy-message');
            const editButton = document.getElementById('edit-message');
            const deleteButton = document.getElementById('delete-message');
            
            document.addEventListener('click', (e) => {
                if (!toolbar.contains(e.target) && 
                    !e.target.closest('.message')) {
                    toolbar.classList.remove('active');
                    selectedMessageForAction = null;
                }
            });
            
            let longPressTimer;
            document.addEventListener('mousedown', (e) => {
                const messageElement = e.target.closest('.message');
                if (messageElement) {
                    longPressTimer = setTimeout(() => {
                        showToolbarForMessage(messageElement, e);
                    }, 500);
                }
            });
            
            document.addEventListener('mouseup', () => {
                clearTimeout(longPressTimer);
            });
            
            document.addEventListener('contextmenu', (e) => {
                const messageElement = e.target.closest('.message');
                if (messageElement) {
                    e.preventDefault();
                    showToolbarForMessage(messageElement, e);
                }
            });
            
            function showToolbarForMessage(messageElement, event) {
                selectedMessageForAction = messageElement;
                
                toolbar.style.left = `${event.pageX}px`;
                toolbar.style.top = `${event.pageY}px`;
                toolbar.classList.add('active');
                
                const isOwnMessage = messageElement.classList.contains('self');
                editButton.style.display = isOwnMessage ? 'block' : 'none';
                deleteButton.style.display = isOwnMessage ? 'block' : 'none';
            }
            
            copyButton.addEventListener('click', () => {
                if (selectedMessageForAction) {
                    const textElement = selectedMessageForAction.querySelector('p');
                    if (textElement) {
                        navigator.clipboard.writeText(textElement.textContent)
                            .then(() => {
                                toolbar.classList.remove('active');
                                showNotification('تم نسخ الرسالة');
                            })
                            .catch(err => {
                                console.error('Could not copy text: ', err);
                            });
                    }
                }
            });
            
            editButton.addEventListener('click', () => {
                toolbar.classList.remove('active');
            });
            
            deleteButton.addEventListener('click', () => {
                toolbar.classList.remove('active');
            });
        }
        
        function showNotification(message) {
            const notification = document.createElement('div');
            notification.textContent = message;
            notification.style.position = 'fixed';
            notification.style.bottom = '80px';
            notification.style.left = '50%';
            notification.style.transform = 'translateX(-50%)';
            notification.style.backgroundColor = 'rgba(0,0,0,0.7)';
            notification.style.color = 'white';
            notification.style.padding = '8px 16px';
            notification.style.borderRadius = '20px';
            notification.style.zIndex = '1000';
            
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.style.opacity = '0';
                notification.style.transition = 'opacity 0.5s';
                setTimeout(() => {
                    document.body.removeChild(notification);
                }, 500);
            }, 2000);
        }

        // New function to update active users count for all groups
        function updateActiveUsersCount() {
            const groupsToTrack = [
                null, // Main group
                'friends-group',
                'tech-group',
                'gaming-group',
                'sports-group',
                'movies-group',
                'music-group',
                'cooking-group',
                'travel-group',
                'books-group'
            ];
            
            for (const groupId of groupsToTrack) {
                const usersRef = ref(db, 'users/');
                
                if (activeUsersRefs[groupId]) {
                    // Unsubscribe from previous listener
                    activeUsersRefs[groupId]();
                }
                
                // Create a new listener for each group
                activeUsersRefs[groupId] = onValue(usersRef, (snapshot) => {
                    if (snapshot.exists()) {
                        let activeCount = 0;
                        snapshot.forEach((userSnapshot) => {
                            const userData = userSnapshot.val();
                            if (userData.isOnline) {
                                activeCount++;
                            }
                        });
                        
                        // Update the UI to show active users count
                        let unreadElement;
                        if (groupId === null) {
                            unreadElement = document.querySelector('#main-group .group-unread');
                        } else {
                            unreadElement = document.querySelector(`#group-${groupId.split('-')[0]} .group-unread`);
                        }
                        
                        if (unreadElement) {
                            unreadElement.textContent = activeCount;
                        }
                    }
                });
            }
        }

        window.onload = function() {
            showPage('auth-page');

            auth.onAuthStateChanged((user) => {
                if (user) {
                    const email = user.email;
                    if (email && email.includes('@chatapp.example')) {
                        username = email.split('@')[0];
                        initializeUser();
                        showPage('groups-page');
                    }
                }
            });

            document.getElementById('login-tab').addEventListener('click', function() {
                document.querySelectorAll('.auth-tab').forEach(tab => tab.classList.remove('active'));
                document.querySelectorAll('.auth-form').forEach(form => form.classList.remove('active'));
                this.classList.add('active');
                document.getElementById('login-form').classList.add('active');
            });
            
            document.getElementById('register-tab').addEventListener('click', function() {
                document.querySelectorAll('.auth-tab').forEach(tab => tab.classList.remove('active'));
                document.querySelectorAll('.auth-form').forEach(form => form.classList.remove('active'));
                this.classList.add('active');
                document.getElementById('register-form').classList.add('active');
            });

            document.getElementById('register-button').addEventListener('click', async () => {
                const username = document.getElementById('register-username').value.trim();
                const password = document.getElementById('register-password').value;
                const confirmPassword = document.getElementById('register-confirm-password').value;
                
                const success = await registerUser(username, password, confirmPassword);
                if (success) {
                    window.username = username;
                    initializeUser();
                    showPage('groups-page');
                }
            });

            document.getElementById('login-button').addEventListener('click', async () => {
                const username = document.getElementById('login-username').value.trim();
                const password = document.getElementById('login-password').value;
                
                const success = await loginUser(username, password);
                if (success) {
                    window.username = username;
                    initializeUser();
                    showPage('groups-page');
                }
            });

            document.getElementById('login-password').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    document.getElementById('login-button').click();
                }
            });
            
            document.getElementById('register-confirm-password').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    document.getElementById('register-button').click();
                }
            });

            document.getElementById('back-to-menu').addEventListener('click', () => {
                showPage('groups-page');
            });

            document.getElementById('main-group').addEventListener('click', () => {
                showPage('chat-page');
                currentChatId = null; 
                document.querySelector('.chat-header h1').textContent = "المجموعة العامة";
                displayMessages(false);
            });
            
            document.getElementById('group-friends').addEventListener('click', () => {
                showPage('chat-page');
                currentChatId = 'friends-group'; 
                document.querySelector('.chat-header h1').textContent = "مجموعة الأصدقاء";
                displayMessages(true);
            });

            document.getElementById('group-tech').addEventListener('click', () => {
                showPage('chat-page');
                currentChatId = 'tech-group'; 
                document.querySelector('.chat-header h1').textContent = "مجموعة التقنية";
                displayMessages(true);
            });
            
            document.getElementById('group-gaming').addEventListener('click', () => {
                showPage('chat-page');
                currentChatId = 'gaming-group'; 
                document.querySelector('.chat-header h1').textContent = "مجموعة الألعاب";
                displayMessages(true);
            });
            
            document.getElementById('group-sports').addEventListener('click', () => {
                showPage('chat-page');
                currentChatId = 'sports-group'; 
                document.querySelector('.chat-header h1').textContent = "مجموعة الرياضة";
                displayMessages(true);
            });
            
            document.getElementById('group-movies').addEventListener('click', () => {
                showPage('chat-page');
                currentChatId = 'movies-group'; 
                document.querySelector('.chat-header h1').textContent = "مجموعة الأفلام";
                displayMessages(true);
            });
            
            document.getElementById('group-music').addEventListener('click', () => {
                showPage('chat-page');
                currentChatId = 'music-group'; 
                document.querySelector('.chat-header h1').textContent = "مجموعة الموسيقى";
                displayMessages(true);
            });
            
            document.getElementById('group-cooking').addEventListener('click', () => {
                showPage('chat-page');
                currentChatId = 'cooking-group'; 
                document.querySelector('.chat-header h1').textContent = "مجموعة الطبخ";
                displayMessages(true);
            });
            
            document.getElementById('group-travel').addEventListener('click', () => {
                showPage('chat-page');
                currentChatId = 'travel-group'; 
                document.querySelector('.chat-header h1').textContent = "مجموعة السفر";
                displayMessages(true);
            });
            
            document.getElementById('group-books').addEventListener('click', () => {
                showPage('chat-page');
                currentChatId = 'books-group'; 
                document.querySelector('.chat-header h1').textContent = "مجموعة الكتب";
                displayMessages(true);
            });

            document.getElementById('logout-button').addEventListener('click', () => {
                auth.signOut().then(() => {
                    showPage('auth-page');
                }).catch((error) => {
                    console.error('Error signing out:', error);
                });
            });

            document.getElementById('send-message').addEventListener('click', () => {
                const messageText = document.getElementById('message-text').value.trim();
                if (messageText) {
                    sendMessage(messageText);
                    document.getElementById('message-text').value = '';
                }
            });

            document.getElementById('message-text').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    const messageText = this.value.trim();
                    if (messageText) {
                        sendMessage(messageText);
                        this.value = '';
                    }
                }
            });

            document.getElementById('image-button').addEventListener('click', function() {
                document.getElementById('image-upload').click();
            });

            document.getElementById('image-upload').addEventListener('change', function(e) {
                if (e.target.files[0]) {
                    uploadImage(e.target.files[0], false);
                }
            });
            
            document.getElementById('message-text').addEventListener('input', function(e) {
                // Removed updating text direction indicator functionality
            });

            document.getElementById('image-overlay').addEventListener('click', function(e) {
                if (e.target === this || e.target.id === 'close-image-button' || e.target.closest('#close-image-button')) {
                    this.classList.remove('active');
                }
            });
            
            initializeMessageActions();
            
            document.getElementById('new-group-modal').addEventListener('click', function(e) {
                if (e.target === this) {
                    this.classList.remove('active');
                }
            });
            
            document.getElementById('create-group-button').addEventListener('click', async function() {
                const groupName = document.getElementById('group-name').value.trim();
                const groupDescription = document.getElementById('group-description').value.trim();
                
                if (!groupName) {
                    alert('الرجاء إدخال اسم المجموعة');
                    return;
                }
                
                try {
                    const newGroupRef = push(ref(db, 'groups/'));
                    const groupId = newGroupRef.key;
                    
                    await set(newGroupRef, {
                        name: groupName,
                        description: groupDescription,
                        createdBy: username,
                        createdAt: Date.now()
                    });
                    
                    await set(ref(db, `groupChats/${groupId}/welcome`), {
                        username: 'system',
                        text: `مرحباً بكم في ${groupName}!`,
                        timestamp: Date.now()
                    });
                    
                    document.getElementById('new-group-modal').classList.remove('active');
                    document.getElementById('group-name').value = '';
                    document.getElementById('group-description').value = '';
                    
                    currentChatId = groupId;
                    document.querySelector('.chat-header h1').textContent = groupName;
                    showPage('chat-page');
                    displayMessages(true);
                    
                } catch (error) {
                    console.error('Error creating group:', error);
                    alert('حدث خطأ أثناء إنشاء المجموعة');
                }
            });
            
            async function initializeAllGroups() {
                const groupsToInitialize = [
                    { id: 'friends-group', name: 'مجموعة الأصدقاء', description: 'للنقاشات الودية والمرح' },
                    { id: 'tech-group', name: 'مجموعة التقنية', description: 'لمناقشة أحدث التقنيات' },
                    { id: 'gaming-group', name: 'مجموعة الألعاب', description: 'لمحبي الألعاب الإلكترونية' },
                    { id: 'sports-group', name: 'مجموعة الرياضة', description: 'لمتابعة أخبار الرياضة' },
                    { id: 'movies-group', name: 'مجموعة الأفلام', description: 'لمناقشة الأفلام والمسلسلات' },
                    { id: 'music-group', name: 'مجموعة الموسيقى', description: 'لمحبي الموسيقى والغناء' },
                    { id: 'cooking-group', name: 'مجموعة الطبخ', description: 'لتبادل وصفات الطعام' },
                    { id: 'travel-group', name: 'مجموعة السفر', description: 'لمشاركة تجارب السفر' },
                    { id: 'books-group', name: 'مجموعة الكتب', description: 'لمناقشة الكتب والقراءة' }
                ];
                
                for (const group of groupsToInitialize) {
                    const groupRef = ref(db, `groups/${group.id}`);
                    const snapshot = await get(groupRef);
                    
                    if (!snapshot.exists()) {
                        await set(groupRef, {
                            name: group.name,
                            description: group.description,
                            createdBy: "system",
                            createdAt: Date.now()
                        });
                        
                        await set(ref(db, `groupChats/${group.id}/welcome`), {
                            username: 'system',
                            text: `مرحباً بكم في ${group.name}!`,
                            timestamp: Date.now()
                        });
                    }
                }
            }
            
            initializeAllGroups();
            updateActiveUsersCount();
        };
    </script>
</body>
</html>
